<html>
<head>
<title>Conway's Game of Life</title>
<style>
#gol {
    width: 600px;
    height: 600px;
    border: 1px solid black;
}
</style>
<script src="https://code.jquery.com/jquery-2.2.4.js"></script>
</head>

<body>
<canvas id="gol" width="600" height="600"></canvas>
<br />
<button id="next-btn">Next</button> <button id="run-btn">Run</button> <button id="clear-btn">Clear</button> <button id="random-btn">Random</button><br />
Generations duration: <input type="text" id="speed" value="500" size="5" /> milliseconds <button id="speed-btn">Set</button><br />
<input type="text" id="steps" value="0" size="5" /> steps<br />
<button id="img-save">Save as image</button><br />
<textarea id="importexport" cols="65" rows="10"></textarea> <button id="import-btn">Import</button>

<script>

function debug() {
    var args =  Array.from(arguments);
    var values = args.join(", ");
    console.log(values);
}

var WIDTH = 60;
var HEIGHT = 60;
var CELL_SIZE = 10;
var RUNNING = 0;

var steps = 0;

var grid = new Array(WIDTH);
for (var i = 0; i < WIDTH; i ++) {
    grid[i] = new Array(HEIGHT);
}
for (var i = 0; i < WIDTH; i ++) {
    for (var j = 0; j < HEIGHT; j++) {
        grid[i][j] = false;
    }
}


var canvas = document.getElementById('gol');
var ctx = canvas.getContext('2d');
var elemLeft = canvas.offsetLeft;
var elemTop = canvas.offsetTop;
var speed = 500;

canvas.addEventListener("click", function(event) {
    var x = event.pageX - elemLeft;
    var y = event.pageY - elemTop;
    clickGrid(ctx, x, y);
});


function clickGrid(ctx, x, y) {
    var Xcoord = Math.floor(x / CELL_SIZE);
    var Ycoord = Math.floor(y / CELL_SIZE);
    grid[Xcoord][Ycoord] = !grid[Xcoord][Ycoord];    
    fillGrid(ctx, Xcoord, Ycoord);
    encode();
}

function draw() {
    for (var i = 0; i < WIDTH; i++) {
        for (var j = 0; j < HEIGHT; j++) {
            fillGrid(ctx, i, j);
        }
    }
}

function fillGrid(ctx, x, y) {
    if (grid[x][y]) {
        ctx.fillStyle = 'rgb(0, 0, 0)';
    }
    else {
        ctx.fillStyle = 'rgb(255, 255, 255)';
    }
    ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
}

function next(grid) {
    var next = new Array(WIDTH);
    for (var i = 0; i < WIDTH; i ++) {
        next[i] = new Array(HEIGHT);
    }
    for (var i = 0; i < WIDTH; i++) {
        for (var j = 0; j < HEIGHT; j++) {
            var n = countAliveNeighbours(i, j);
            if (n < 2 && grid[i][j]) {
                next[i][j] = false;
            }
            else if ((n == 2 || n == 3) && grid[i][j]) {
                next[i][j] = true;
            }
            else if (n > 3 && grid[i][j]) {
                next[i][j] = false;
            }
            else if (n == 3 && !grid[i][j]) {
                next[i][j] = true;
            }
            else {
                next[i][j] = false;
            }
        }
    }
    return next;
}

function getCell(x, y) {
    return (grid[x] && grid[x][y]) || undefined;
}

function countAliveNeighbours(x, y) {
    var n = 0;
    var neighbours = [
        getCell(x - 1, y - 1),
        getCell(x - 1, y),
        getCell(x - 1, y + 1),
        getCell(x, y - 1),
        getCell(x, y + 1),
        getCell(x + 1, y - 1),
        getCell(x + 1, y),
        getCell(x + 1, y + 1)
    ];
    for (var i = 0; i < neighbours.length; i++) {
        if (neighbours[i] === true) {
            n++;
        }
    }
    return n;
}

function encode() {
    //b = parseInt(a, 2)  from binary to dec
    var fullString = "";
    for (var i = 0; i < WIDTH; i ++) {
        for (var j = 0; j < HEIGHT; j++) {
            if (grid[j][i]) {
                fullString += "1";
            }
            else {
                fullString += "0";
            }
        }
    }
    var encodedString = "";
    for (var i = 0; i < WIDTH * HEIGHT; i = i + 8) {
        var word = fullString.substr(i, 8);
        var n = parseInt(word, 2);
        if (n < 10) {
            n = "00" + n;
        }
        else if (n < 100) {
            n = "0" + n;
        }
        encodedString += n;    
    }
    
    $("#importexport").val(encodedString);
}

function decode() {
    //a.toString(2) -- need to pad
    var encodedString = $("#importexport").val();
    var binaryString = "";
    for (var i = 0; i < WIDTH * HEIGHT / 8 * 3; i = i + 3) {
        var digit = parseInt(encodedString.substr(i, 3));
        var binary = digit.toString(2);
        binary = ('00000000' + binary).substring(binary.length)
        binaryString += binary;
    }

    for (var i = 0; i < WIDTH; i ++) {
        for (var j = 0; j < HEIGHT; j++) {
            if (binaryString.substr(i*WIDTH + j, 1) == "1") {
                grid[j][i] = true;
            }
            else {
                grid[j][i] = false;
            }
            
        }
    }
    draw();

}

function run() {
    steps++;
    $("#steps").val(steps);
    grid = next(grid);
    draw();
    encode();
}

$(document).ready(function() {
    $("#next-btn").on("click", run);
    $("#run-btn").on("click", function() {
        if (RUNNING > 0) {
            clearInterval(RUNNING);
            RUNNING = 0;
            $("#run-btn").html("Run");
        }
        else {
            RUNNING = setInterval(run, speed);
            $("#run-btn").html("Stop");
        }
    });
    $("#clear-btn").on("click", function() {
        for (var i = 0; i < WIDTH; i ++) {
            for (var j = 0; j < HEIGHT; j++) {
                grid[i][j] = false;
            }
        }
        steps = 0;
        $("#steps").val(steps);
        $("#importexport").val("");
        draw();
    });
    $("#speed-btn").on("click", function() {
		speed = $("#speed").val();
		clearInterval(RUNNING);
		RUNNING = setInterval(run, speed);
    });
    $("#img-save").on("click", function() {
        window.open(canvas.toDataURL('image/png'));
    });
    $("#random-btn").on("click", function() {
        for (var i = 0; i < WIDTH; i ++) {
            for (var j = 0; j < HEIGHT; j++) {
                var n = Math.floor((Math.random() * 10) + 1);
                grid[i][j] = n > 5;
            }
        }
        steps = 0;
        $("#steps").val(steps);
        draw();
        encode();
    });
    $("#import-btn").on("click", function() {
        decode();
    });
});

</script>
</body>


</html>